// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String?
  pin            String // Hashed PIN
  role           UserRole @default(CASHIER)
  isActive       Boolean  @default(true)
  metadata       Json? // For public/private metadata
  supabaseAuthId String?

  ordersPlaced Order[] @relation("OrdersPlacedByUser")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  CASHIER
}

model Customer {
  id               String   @id @default(cuid())
  fullName         String
  phone            String   @unique
  email            String?  @db.VarChar(255)
  imageUrl         String?
  defaultAddressId String?  @unique
  defaultAddress   Address? @relation("DefaultAddress", fields: [defaultAddressId], references: [id])
  notes            String?

  addresses Address[]
  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
}

model Address {
  id              String  @id @default(cuid())
  customerId      String
  label           String
  street          String
  city            String
  state           String
  zip             String
  extraDirections String?
  isDefault       Boolean @default(false)

  customer Customer @relation(fields: [customerId], references: [id])

  // Back-reference for Customer.defaultAddress relation
  customerDefaultFor Customer? @relation("DefaultAddress")

  deliveryOrders Order[] @relation("DeliveryAddress")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

model MenuCategory {
  id        String  @id @default(cuid())
  name      String
  icon      String? // Emoji or icon identifier (e.g., "üçï", "ü•ó")
  imageUrl  String?
  sortOrder Int     @default(0)

  items MenuItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenuItem {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  basePrice   Decimal @db.Decimal(10, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 3)
  categoryId  String
  isAvailable Boolean @default(true)
  sku         String? @unique
  size        String? // e.g., "Small", "Large", null for non-sized items
  sortOrder   Int     @default(0)

  category       MenuCategory            @relation(fields: [categoryId], references: [id])
  orderItems     OrderItem[]
  modifierGroups MenuItemModifierGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

model Order {
  id                String        @id @default(cuid())
  orderNumber       Int           @unique @default(autoincrement())
  dailySequence     Int           @default(0)
  customerId        String?
  type              OrderType
  status            OrderStatus   @default(NEW)
  subtotal          Decimal       @db.Decimal(10, 2)
  tax               Decimal       @db.Decimal(10, 2)
  deliveryFee       Decimal       @default(0) @db.Decimal(10, 2)
  discountTotal     Decimal       @default(0) @db.Decimal(10, 2)
  total             Decimal       @db.Decimal(10, 2)
  paymentStatus     PaymentStatus @default(UNPAID)
  paymentMethod     PaymentMethod
  placedByUserId    String
  deliveryAddressId String?
  notes             String?

  customer        Customer?   @relation(fields: [customerId], references: [id])
  placedByUser    User        @relation("OrdersPlacedByUser", fields: [placedByUserId], references: [id])
  deliveryAddress Address?    @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  items           OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
  @@index([customerId, createdAt])
}

model OrderItem {
  id                  String  @id @default(cuid())
  orderId             String
  menuItemId          String
  nameSnapshot        String
  unitPriceSnapshot   Decimal @db.Decimal(10, 2)
  quantity            Int
  lineTotal           Decimal @db.Decimal(10, 2)
  specialInstructions String?

  order     Order               @relation(fields: [orderId], references: [id])
  menuItem  MenuItem            @relation(fields: [menuItemId], references: [id])
  modifiers OrderItemModifier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

enum OrderType {
  PICKUP
  DELIVERY
  DINE_IN
}

enum OrderStatus {
  NEW
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  OTHER
}

model Store {
  id      String  @id @default(cuid())
  name    String
  street  String?
  city    String?
  state   String?
  zip     String?
  phone   String?
  email   String?
  logoUrl String? // Can store URL or Base64 Data URI
  ownerId String  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ModifierGroup {
  id              String @id @default(cuid())
  name            String // e.g., "Pizza Toppings", "Drink Size"
  minSelect       Int    @default(0)
  maxSelect       Int    @default(99)
  hideOrderSection Boolean @default(false) // If true, hides order section when configuring items with this modifier group
  requiresSizeFirst Boolean @default(false) // If true, requires size selection before showing this modifier group
  sizeBasedPricing Boolean @default(false) // If true, modifier prices vary based on selected size
  isOptional      Boolean @default(false) // If true, this modifier group is optional (can be skipped)

  modifiers Modifier[]
  menuItems MenuItemModifierGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Modifier {
  id         String              @id @default(cuid())
  name       String // e.g., "Pepperoni", "Mushrooms"
  groupId    String
  group      ModifierGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  prices     ModifierPrice[]
  orderItems OrderItemModifier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId])
}

model ModifierPrice {
  id         String   @id @default(cuid())
  modifierId String
  sizeLabel  String // e.g., "Small", "Large", "Default"
  price      Decimal  @db.Decimal(10, 2)
  modifier   Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  @@index([modifierId])
}

model MenuItemModifierGroup {
  menuItemId      String
  modifierGroupId String
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@id([menuItemId, modifierGroupId])
  @@index([menuItemId])
  @@index([modifierGroupId])
}

model OrderItemModifier {
  id            String    @id @default(cuid())
  orderItemId   String
  modifierId    String
  nameSnapshot  String
  priceSnapshot Decimal   @db.Decimal(10, 2)
  orderItem     OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifier      Modifier  @relation(fields: [modifierId], references: [id])

  createdAt DateTime @default(now())

  @@index([orderItemId])
  @@index([modifierId])
}
